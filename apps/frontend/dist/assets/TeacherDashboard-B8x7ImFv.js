import{r as n,P as T,j as e,c as q,i as ie,k as ce,E as de,l as me,a as U,B as D,I as k,m as xe,n as ue,o as pe,p as he,u as _,b as V,q as B,f as ae,s as z,S as ne,t as M,Q as fe,A as F,v as X,w as ge,x as je,y as ye,e as be,U as Ne,z as ve}from"./index-JBX9P6Qg.js";import{g as G,a as H,b as ee}from"./helpers-snl2sRJ-.js";import{S as re}from"./SearchableSingleUserSelector-DWlEu3dp.js";import{S as Se}from"./Select-BM0zQtf0.js";import{T as we}from"./Table-DlSKKgO4.js";import{B as W}from"./BadgeIconRenderer-BjlOxHvs.js";import{M as le}from"./Modal-NYefmAjZ.js";import{C as Ce}from"./ConfirmationModal-CPL5EhPs.js";import{h as Ie}from"./roleUtils-D7XDrfnq.js";import"./useDebounce-CwzWEB2R.js";const te=({title:t,icon:p,items:s,colorClass:u})=>e.jsxs("div",{className:"bg-slate-50 p-4 rounded-lg h-full",children:[e.jsxs("h3",{className:"flex items-center text-md font-bold text-text-primary mb-3",children:[p,e.jsx("span",{className:"ml-2",children:t})]}),s.length>0?e.jsx("ul",{className:"space-y-3",children:s.map(({student:f,value:h})=>e.jsxs("li",{className:"flex items-center justify-between text-sm",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center font-bold text-xs ${H(f.name)}`,children:G(f.name)}),e.jsx("span",{className:"font-medium",children:f.name})]}),e.jsxs("span",{className:`font-bold ${u}`,children:[h>0?`+${h}`:h," pts"]})]},f.id))}):e.jsx("p",{className:"text-sm text-text-secondary text-center pt-8",children:"No data available."})]}),Ae=({classPoints:t,classStudents:p})=>{const{topMovers:s,studentsToWatch:u,topRewardCats:f,topViolationCats:h}=n.useMemo(()=>{const r=p.map(a=>{const i=t.filter(b=>b.studentId===a.id),x=i.filter(b=>b.points>0).reduce((b,S)=>b+S.points,0),w=i.filter(b=>b.points<0).reduce((b,S)=>b+S.points,0);return{student:a,positivePoints:x,negativePoints:w}}),c=[...r].sort((a,i)=>i.positivePoints-a.positivePoints).filter(a=>a.positivePoints>0).slice(0,5).map(a=>({student:a.student,value:a.positivePoints})),l=[...r].sort((a,i)=>a.negativePoints-i.negativePoints).filter(a=>a.negativePoints<0).slice(0,5).map(a=>({student:a.student,value:a.negativePoints})),o={},g={};t.forEach(a=>{a.type===T.REWARD?o[a.category]=(o[a.category]||0)+1:a.type===T.VIOLATION&&(g[a.category]=(g[a.category]||0)+1)});const d=Object.entries(o).sort(([,a],[,i])=>i-a).slice(0,3).map(([a])=>a),j=Object.entries(g).sort(([,a],[,i])=>i-a).slice(0,3).map(([a])=>a);return{topMovers:c,studentsToWatch:l,topRewardCats:d,topViolationCats:j}},[t,p]);return e.jsx(q,{icon:e.jsx(me,{className:"h-6 w-6 text-primary"}),title:"Class Insights",children:e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsx(te,{title:"Top Positive Movers",icon:e.jsx(ie,{className:"h-6 w-6 text-secondary"}),items:s,colorClass:"text-secondary"}),e.jsx(te,{title:"Students to Watch",icon:e.jsx(ce,{className:"h-6 w-6 text-danger"}),items:u,colorClass:"text-danger"}),e.jsxs("div",{className:"bg-slate-50 p-4 rounded-lg",children:[e.jsxs("h3",{className:"flex items-center text-md font-bold text-text-primary mb-3",children:[e.jsx(de,{className:"h-6 w-6 text-accent"}),e.jsx("span",{className:"ml-2",children:"Class Behavior Trends"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-semibold text-secondary mb-2",children:"Top Reward Reasons"}),f.length>0?e.jsx("ul",{className:"list-disc list-inside text-sm text-text-secondary space-y-1",children:f.map(r=>e.jsx("li",{children:r},r))}):e.jsx("p",{className:"text-sm text-text-secondary",children:"No rewards recorded yet."})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-semibold text-danger mb-2",children:"Top Violation Reasons"}),h.length>0?e.jsx("ul",{className:"list-disc list-inside text-sm text-text-secondary space-y-1",children:h.map(r=>e.jsx("li",{children:r},r))}):e.jsx("p",{className:"text-sm text-text-secondary",children:"No violations recorded yet."})]})]})]})]})})},De=({students:t,onAward:p})=>{const[s,u]=n.useState(""),[f,h]=n.useState(""),[r,c]=n.useState(""),[l,o]=n.useState(""),[g,d]=n.useState("ðŸ†"),[j,a]=n.useState(!1),[i,x]=n.useState(null),[w,b]=n.useState(!1),[S,L]=n.useState(""),v=()=>{u(""),h(""),c(""),o(""),d("ðŸ†")},R=()=>{v(),x(null),b(!1)},$=async A=>{A.preventDefault();const E=t.find(m=>m.id===s);if(!E||!f||!l){x("Please select a student, provide an award name, and reason.");return}a(!0),x(null);try{await ue({recipientId:s,tier:he.BRONZE,type:pe.BEHAVIOR,name:f,description:r||l,reason:l,icon:g||"ðŸ†"}),p(),b(!0),L(E.name)}catch(m){x(m.message)}finally{a(!1)}};return w?e.jsx(q,{title:"Award Bronze Recognition",children:e.jsxs("div",{className:"text-center p-4 h-full flex flex-col justify-center items-center",children:[e.jsx(U,{className:"mx-auto h-12 w-12 text-secondary"}),e.jsx("h3",{className:"mt-2 text-lg font-medium text-text-primary",children:"Success!"}),e.jsxs("p",{className:"mt-2 text-sm text-text-secondary",children:["Bronze award granted to ",S,"."]}),e.jsx(D,{onClick:R,className:"mt-6",variant:"secondary",children:"Award Another Student"})]})}):e.jsx(q,{title:"Award Bronze Recognition",children:e.jsxs("form",{onSubmit:$,className:"space-y-4 max-w-lg mx-auto",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-text-secondary mb-1",children:"Student"}),e.jsx(re,{users:t,selectedUserId:s,onSelectUser:A=>{u(A),x(null)},placeholder:"Search and select a student...",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-text-secondary mb-1",children:"Award Name"}),e.jsx(k,{type:"text",value:f,onChange:A=>h(A.target.value),placeholder:"e.g., Outstanding Leadership",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-text-secondary mb-1",children:"Reason"}),e.jsx(k,{type:"text",value:l,onChange:A=>o(A.target.value),placeholder:"e.g., Showed exceptional leadership during group project",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-text-secondary mb-1",children:"Description (Optional)"}),e.jsx(k,{type:"text",value:r,onChange:A=>c(A.target.value),placeholder:"Provide additional details..."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-text-secondary mb-1",children:"Icon"}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("span",{className:"text-2xl",children:g}),e.jsx(k,{type:"text",value:g,onChange:A=>d(A.target.value),placeholder:"ðŸ†",className:"flex-1"})]}),e.jsx("p",{className:"text-xs text-text-secondary mt-1",children:"Choose an emoji or text icon for this award"})]}),i&&e.jsx("p",{className:"text-sm pt-1 text-danger",children:i}),e.jsxs(D,{type:"submit",className:"w-full !mt-6",disabled:j,children:[e.jsx(xe,{className:"h-5 w-5 mr-2"}),j?"Granting Award...":"Grant Bronze Award"]})]})})},Te=()=>{const{user:t,updateAuthUser:p}=_(),{updateUser:s}=V(),[u,f]=n.useState((t==null?void 0:t.subject)||""),[h,r]=n.useState((t==null?void 0:t.contactNumber)||""),[c,l]=n.useState(!1),[o,g]=n.useState(null),[d,j]=n.useState(!1);if(!t)return e.jsx("p",{children:"User not found."});const a=async w=>{w.preventDefault(),l(!0),g(null),j(!1);try{const b=await s(t.id,{subject:u,contactNumber:h});p(b),j(!0)}catch(b){g(b.message)}finally{l(!1)}},i=()=>{j(!1),g(null)},x=t.role===B.HEAD_OF_CLASS;return e.jsxs("div",{className:"max-w-lg mx-auto",children:[x&&t.className&&e.jsxs("div",{className:"p-4 bg-primary/10 border border-primary/20 rounded-lg mb-6 flex items-start space-x-4",children:[e.jsx(ae,{className:"h-8 w-8 text-primary mt-1 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-bold text-primary",children:"Head of Class Status"}),e.jsxs("p",{className:"text-text-primary",children:["You are assigned as the Head of: ",e.jsx("strong",{children:t.className})]}),e.jsx("p",{className:"text-xs text-text-secondary mt-1",children:"This role is managed by an administrator."})]})]}),d?e.jsxs("div",{className:"text-center p-4",children:[e.jsx(U,{className:"mx-auto h-12 w-12 text-secondary"}),e.jsx("h3",{className:"mt-2 text-lg font-medium text-text-primary",children:"Profile Updated!"}),e.jsx("p",{className:"mt-2 text-sm text-text-secondary",children:"Your changes have been saved successfully."}),e.jsx(D,{onClick:i,className:"mt-6",variant:"secondary",children:"Make Another Change"})]}):e.jsxs("form",{onSubmit:a,className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-text-secondary mb-1",children:"Full Name"}),e.jsx(k,{type:"text",value:t.name,readOnly:!0,disabled:!0,className:"bg-slate-100 cursor-not-allowed"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-text-secondary mb-1",children:"NISN / User ID"}),e.jsx(k,{type:"text",value:t.nisn,readOnly:!0,disabled:!0,className:"bg-slate-100 cursor-not-allowed"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-text-secondary mb-1",children:"Email Address"}),e.jsx(k,{type:"email",value:t.email,readOnly:!0,disabled:!0,className:"bg-slate-100 cursor-not-allowed"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-text-secondary mb-1",children:"Subject(s)"}),e.jsx(k,{type:"text",value:u,onChange:w=>f(w.target.value),placeholder:"e.g., Math, Science"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-text-secondary mb-1",children:"Contact Number"}),e.jsx(k,{type:"tel",value:h,onChange:w=>r(w.target.value),placeholder:"e.g., 555-123-4567"})]}),o&&e.jsx("div",{className:"text-center text-sm p-3 rounded-lg bg-red-100 text-red-800",children:o}),e.jsx(D,{type:"submit",className:"w-full !mt-8",disabled:c,children:c?"Saving...":"Save Changes"})]})]})},Le=({students:t,logType:p,onStudentSelect:s,onUpdate:u})=>{const{addPointLog:f,actionPresets:h}=V(),[r,c]=n.useState(""),[l,o]=n.useState(p===T.REWARD?10:5),[g,d]=n.useState(""),[j,a]=n.useState(""),[i,x]=n.useState(""),[w,b]=n.useState(!1),[S,L]=n.useState(null),[v,R]=n.useState(!1),[$,A]=n.useState(""),E=n.useMemo(()=>{const y=p===T.REWARD?z.REWARD:z.VIOLATION;return h.filter(P=>P.type===y&&!P.isArchived)},[h,p]);n.useEffect(()=>{s(r||null)},[r,s]),n.useEffect(()=>{I(!1)},[p]);const m=y=>{x(y),L(null);const P=E.find(O=>O.id===y);P?(o(Math.abs(P.points)),d(P.category),a(P.description)):(o(p===T.REWARD?10:5),d(""),a(""))},I=(y=!0)=>{y&&c(""),o(p===T.REWARD?10:5),d(""),a(""),x("")},C=()=>{I(),R(!1),L(null)},N=async y=>{y.preventDefault(),y.stopPropagation();const P=t.find(O=>O.id===r);if(!P||!g||!j){L("Please fill all required fields.");return}b(!0),L(null);try{await f({studentId:r,points:p===T.VIOLATION?-Math.abs(l):Math.abs(l),type:p,category:g,description:j}),u(),R(!0),A(P.name)}catch(O){L(O.message)}finally{b(!1)}};return v?e.jsxs("div",{className:"text-center p-4 h-full flex flex-col justify-center items-center",children:[e.jsx(U,{className:"mx-auto h-12 w-12 text-secondary"}),e.jsx("h3",{className:"mt-2 text-lg font-medium text-text-primary",children:"Success!"}),e.jsxs("p",{className:"mt-2 text-sm text-text-secondary",children:["Points logged for ",$,"."]}),e.jsx(D,{type:"button",onClick:C,className:"mt-6",variant:"secondary",children:"Log Another"})]}):e.jsxs("form",{onSubmit:N,className:"space-y-4",noValidate:!0,children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-text-secondary mb-1",children:"Student"}),e.jsx(re,{users:t,selectedUserId:r,onSelectUser:y=>{c(y),L(null)},placeholder:"Search and select a student...",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-text-secondary mb-1",children:"Select a Preset (Optional)"}),e.jsxs(Se,{value:i,onChange:y=>m(y.target.value),children:[e.jsx("option",{value:"",children:"-- Manual Entry --"}),E.map(y=>e.jsx("option",{value:y.id,children:y.name},y.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-text-secondary mb-1",children:"Points"}),e.jsx(k,{type:"number",min:"0",value:l,onChange:y=>o(Number(y.target.value)),required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-text-secondary mb-1",children:"Category / Keywords"}),e.jsx(k,{type:"text",value:g,onChange:y=>d(y.target.value),placeholder:"e.g., Homework, Participation",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-text-secondary mb-1",children:"Description"}),e.jsx(k,{type:"text",value:j,onChange:y=>a(y.target.value),placeholder:"Provide details...",required:!0})]}),S&&e.jsx("p",{className:"text-sm pt-1 text-danger",children:S}),e.jsx(D,{type:"submit",className:"w-full !mt-6",disabled:w,children:w?"Logging...":"Log Points"})]})},Pe=({data:t,width:p=120,height:s=40,strokeWidth:u=2,className:f=""})=>{if(!t||t.length<2)return e.jsx("div",{className:"text-xs text-text-secondary h-full w-full flex items-center justify-center",children:"Not enough data for trend."});const h=Math.min(...t),c=Math.max(...t)-h,l=t.map((a,i)=>{const x=i/(t.length-1)*p,w=s-(a-h)/(c||1)*s;return`${x.toFixed(2)},${w.toFixed(2)}`}).join(" "),o={x:0,y:s-(t[0]-h)/(c||1)*s},g={x:p,y:s-(t[t.length-1]-h)/(c||1)*s},d=t[t.length-1]>t[0]?"stroke-secondary":t[t.length-1]<t[0]?"stroke-danger":"stroke-blue-400",j=d.replace("stroke-","fill-");return e.jsxs("svg",{className:f,width:p,height:s,viewBox:`-2 -2 ${p+4} ${s+4}`,xmlns:"http://www.w3.org/2000/svg",children:[e.jsx("polyline",{fill:"none",className:d,strokeWidth:u,points:l,strokeLinecap:"round",strokeLinejoin:"round"}),e.jsx("circle",{cx:o.x,cy:o.y,r:u,className:"fill-blue-400"}),e.jsx("circle",{cx:g.x,cy:g.y,r:u,className:j})]})},ke=({student:t,points:p})=>{if(!t)return null;const s=n.useMemo(()=>p.filter(c=>c.studentId===t.id),[p,t.id]),u=Math.max(0,s.reduce((c,l)=>c+l.points,0)),f=n.useMemo(()=>s.filter(c=>c.type===T.VIOLATION).sort((c,l)=>new Date(l.timestamp).getTime()-new Date(c.timestamp).getTime())[0],[s]),h=n.useMemo(()=>s.filter(c=>c.badge).length,[s]),r=n.useMemo(()=>{if(s.length===0)return Array(30).fill(100);const l=[...s].sort((i,x)=>new Date(i.timestamp).getTime()-new Date(x.timestamp).getTime()),o=new Date;o.setDate(o.getDate()-29),o.setHours(0,0,0,0);const g=l.filter(i=>new Date(i.timestamp)<o).reduce((i,x)=>i+x.points,0),d=new Map;l.filter(i=>new Date(i.timestamp)>=o).forEach(i=>{const x=new Date(i.timestamp).toISOString().split("T")[0];d.set(x,(d.get(x)||0)+i.points)});const j=new Array(30).fill(0);let a=g;for(let i=0;i<30;i++){const x=new Date(o);x.setDate(o.getDate()+i);const w=x.toISOString().split("T")[0];a+=d.get(w)||0,j[i]=a}return j.map(i=>Math.max(0,i))},[s]);return e.jsxs("div",{className:"p-4 bg-slate-50 border border-border rounded-lg mt-4 animate-fade-in-up",children:[e.jsxs("h4",{className:"font-bold text-text-primary",children:[t.name,"'s Snapshot"]}),t.className&&e.jsx("p",{className:"text-xs text-text-secondary -mt-1 mb-2",children:t.className}),e.jsxs("div",{className:"text-sm text-text-secondary mt-2 space-y-2",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{children:"Current Points:"}),e.jsx("span",{className:"font-bold text-primary text-lg",children:u})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{children:"Badges Earned:"}),e.jsx("span",{className:"font-bold text-accent",children:h})]}),e.jsxs("div",{className:"pt-2",children:[e.jsx("h5",{className:"text-xs font-medium text-text-secondary mb-1",children:"30-Day Trend"}),e.jsx("div",{className:"flex justify-center items-center bg-white p-2 rounded-md shadow-inner",children:e.jsx(Pe,{data:r})})]}),f?e.jsxs("p",{className:"pt-2",children:["Last Violation: ",e.jsx("span",{className:"font-medium text-danger",children:f.category})," on ",new Date(f.timestamp).toLocaleDateString()]}):e.jsx("p",{className:"pt-2 text-secondary",children:"No violations on record. Great job!"})]})]})},Re=({student:t,onClose:p})=>{const{actionPresets:s,addPointLog:u}=V(),[f,h]=n.useState(!1),[r,c]=n.useState(null),l=n.useMemo(()=>s.filter(d=>d.type===z.VIOLATION&&!d.isArchived),[s]),o=()=>{f||(h(!1),c(null),p())},g=async d=>{if(!(!t||f)){h(!0),c(null);try{await u({studentId:t.id,points:d.points,type:T.VIOLATION,category:d.category,description:d.description}),c({type:"success",message:`Violation logged for ${t.name}.`})}catch(j){c({type:"error",message:j.message})}finally{h(!1)}}};return t?e.jsx(le,{isOpen:!!t,onClose:o,title:(r==null?void 0:r.type)==="success"?"Success":`Log Violation for ${t.name}`,children:(r==null?void 0:r.type)==="success"?e.jsxs("div",{className:"text-center py-4",children:[e.jsx(U,{className:"mx-auto h-12 w-12 text-secondary"}),e.jsx("h3",{className:"mt-2 text-lg font-medium text-text-primary",children:"Violation Logged"}),e.jsx("p",{className:"mt-2 text-sm text-text-secondary",children:r.message}),e.jsx(D,{onClick:o,className:"mt-6",variant:"secondary",children:"Close"})]}):e.jsxs("div",{children:[e.jsx("p",{className:"text-text-secondary mb-4",children:"Select a common violation to quickly log points."}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3",children:l.map(d=>e.jsx(D,{onClick:()=>g(d),disabled:f,variant:"danger-ghost",className:"!font-normal justify-start text-left h-auto py-3",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"font-semibold",children:d.name}),e.jsxs("span",{className:"text-xs",children:[d.points," points"]})]})},d.id))}),l.length===0&&e.jsxs("div",{className:"text-center py-8 text-text-secondary",children:[e.jsx(ne,{className:"h-8 w-8 mx-auto mb-2"}),e.jsx("p",{children:"No violation presets have been configured by the administrator."})]}),(r==null?void 0:r.type)==="error"&&e.jsx("div",{className:"mt-4 text-sm p-3 rounded-lg bg-red-100 text-red-800",children:r.message})]})}):null},Ee=({badges:t})=>{const p={[M.GOLD]:0,[M.SILVER]:0,[M.BRONZE]:0},s=[];return t.forEach(u=>{u.icon?s.push(u):p[u.tier]++}),e.jsxs("div",{className:"flex items-center space-x-3",children:[s.map(u=>e.jsx(W,{badge:u,className:`h-5 w-5 ${ee(u.tier)}`},u.id)),Object.entries(p).map(([u,f])=>{if(f===0)return null;const h={tier:u,id:u,reason:"",awardedOn:new Date,awardedBy:""},r=ee(u);return e.jsxs("span",{className:`flex items-center text-xs font-medium ${r}`,children:[e.jsx(W,{badge:h,className:"h-5 w-5 mr-1"}),f]},u)}),t.length===0&&e.jsx("span",{className:"text-xs text-text-secondary",children:"No badges"})]})},Me=({students:t,points:p,onUpdate:s})=>{const[u,f]=n.useState(null),h=n.useMemo(()=>t.map(l=>{const o=p.filter(j=>j.studentId===l.id),g=Math.max(0,o.reduce((j,a)=>j+a.points,0)),d=o.filter(j=>j.badge).map(j=>j.badge);return{id:l.id,name:l.name,totalPoints:g,badges:d,originalStudent:l}}).sort((l,o)=>{if(l.totalPoints!==o.totalPoints)return o.totalPoints-l.totalPoints;const g=l.badges.filter(S=>S.tier===M.GOLD).length,d=o.badges.filter(S=>S.tier===M.GOLD).length;if(g!==d)return d-g;const j=l.badges.filter(S=>S.tier===M.SILVER).length,a=o.badges.filter(S=>S.tier===M.SILVER).length;if(j!==a)return a-j;const i=l.badges.filter(S=>S.tier===M.BRONZE).length,x=o.badges.filter(S=>S.tier===M.BRONZE).length;if(i!==x)return x-i;const w=l.name||"",b=o.name||"";return w.localeCompare(b)}),[t,p]),r=()=>{f(null),s()};return t.length===0?e.jsx("p",{className:"text-text-secondary text-center py-4",children:"There are no students assigned to your class."}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"max-h-[30rem] overflow-y-auto",children:e.jsx(we,{headers:["Rank","Student","Total Points","Badges","Actions"],children:h.map((c,l)=>e.jsxs("tr",{className:"hover:bg-slate-50",children:[e.jsx("td",{className:"px-6 py-4 font-bold text-text-primary text-center w-16",children:l+1}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:`w-9 h-9 rounded-full flex-shrink-0 flex items-center justify-center font-bold text-sm ${H(c.name)}`,children:G(c.name)}),e.jsx("span",{className:"font-medium text-text-primary",children:c.name})]})}),e.jsx("td",{className:"px-6 py-4 font-bold text-lg text-primary",children:c.totalPoints}),e.jsx("td",{className:"px-6 py-4",children:e.jsx(Ee,{badges:c.badges})}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs(D,{size:"sm",variant:"danger-ghost",onClick:()=>f(c.originalStudent),children:[e.jsx(ne,{className:"h-4 w-4 mr-1.5"}),"Log Violation"]})})]},c.id))})}),e.jsx(Re,{student:u,onClose:r})]})},Oe=({item:t,onClose:p,onConfirm:s})=>{var a;const[u,f]=n.useState(""),[h,r]=n.useState(!1),[c,l]=n.useState(null),[o,g]=n.useState(!1);if(!t)return null;const d=()=>{h||(f(""),l(null),g(!1),p())},j=async i=>{if(i.preventDefault(),l(null),t.type==="quest"&&!u.trim()){l("Feedback notes are required to reject a quest submission.");return}r(!0);try{await s(u),g(!0)}catch(x){l(x.message)}finally{r(!1)}};return e.jsx(le,{isOpen:!!t,onClose:d,title:o?"Success":`Reject Submission for ${(a=t.student)==null?void 0:a.name}`,children:o?e.jsxs("div",{className:"text-center py-4",children:[e.jsx(U,{className:"mx-auto h-12 w-12 text-secondary"}),e.jsx("h3",{className:"mt-2 text-lg font-medium text-text-primary",children:"Submission Rejected"}),e.jsx("p",{className:"mt-2 text-sm text-text-secondary",children:"The student has been notified of the outcome."}),e.jsx(D,{onClick:d,className:"mt-6",variant:"secondary",children:"Close"})]}):e.jsxs("form",{onSubmit:j,className:"space-y-4",children:[e.jsx("p",{className:"text-text-secondary",children:t.type==="quest"?"Please provide feedback for the student. This will be visible to them.":"You are about to reject this appeal. This action is final."}),t.type==="quest"&&e.jsx("textarea",{value:u,onChange:i=>f(i.target.value),placeholder:"Constructive feedback (required)...",rows:4,required:!0,className:"shadow-sm appearance-none border border-border rounded-lg w-full py-2 px-3 bg-white text-text-primary placeholder-text-secondary/70 leading-tight focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent text-sm"}),c&&e.jsx("p",{className:"text-sm text-danger",children:c}),e.jsxs("div",{className:"flex justify-end gap-2 pt-4",children:[e.jsx(D,{type:"button",variant:"neutral",onClick:d,disabled:h,children:"Cancel"}),e.jsx(D,{type:"submit",variant:"danger",disabled:h,children:h?"Processing...":"Confirm Rejection"})]})]})})},se=({questParticipants:t,quests:p,users:s,appeals:u,points:f,onUpdate:h})=>{var A,E;const{user:r}=_(),{reviewQuestCompletion:c,reviewAppeal:l}=V(),[o,g]=n.useState("all"),[d,j]=n.useState(null),[a,i]=n.useState(null),[x,w]=n.useState(null),b=n.useMemo(()=>{if(!r)return[];const m=t.filter(C=>C.status===fe.SUBMITTED_FOR_REVIEW).map(C=>{const N=p.find(y=>y.id===C.questId);return N&&(N.supervisorId===r.id||r.role===B.ADMIN||r.role===B.SUPER_SECRET_ADMIN)?{id:`quest-${C.questId}-${C.studentId}`,type:"quest",submittedAt:new Date(C.submittedAt),student:s.find(y=>y.id===C.studentId),data:{...C,quest:N}}:null}).filter(C=>!!C);let I=[];if(r.role===B.HEAD_OF_CLASS&&r.classId){const C=s.filter(N=>N.role===B.STUDENT&&N.classId===r.classId).map(N=>N.id);I=u.filter(N=>N.status===F.PENDING&&C.includes(N.studentId)).map(N=>({id:`appeal-${N.id}`,type:"appeal",submittedAt:new Date(N.submittedAt),student:s.find(y=>y.id===N.studentId),data:{...N,originalLog:f.find(y=>y.id===N.pointLogId)}}))}return[...m,...I].sort((C,N)=>N.submittedAt.getTime()-C.submittedAt.getTime())},[t,p,u,f,s,r]),S=n.useMemo(()=>o==="all"?b:b.filter(m=>m.type===o),[o,b]),L=m=>{i(m)},v=async()=>{a&&(a.type==="quest"?await c(a.data.questId,a.data.studentId,!0):await l(a.data.id,F.APPROVED),h(),i(null))},R=async m=>{x&&(x.type==="quest"?await c(x.data.questId,x.data.studentId,!1,m):await l(x.data.id,F.REJECTED),h())},$=m=>{var y,P,O,Q,Y,Z,K;const I=d===m.id,C={quest:e.jsx(je,{className:"h-5 w-5 text-amber-700"}),appeal:e.jsx(X,{className:"h-5 w-5 text-slate-600 dark:text-slate-400"})},N=m.type==="quest"?`Quest: ${m.data.quest.title}`:`Appeal: ${(y=m.data.originalLog)==null?void 0:y.points} pts - ${(P=m.data.originalLog)==null?void 0:P.category}`;return e.jsxs("div",{className:"bg-slate-50/70 border border-border rounded-lg overflow-hidden",children:[e.jsxs("div",{className:"p-4 flex justify-between items-center cursor-pointer hover:bg-slate-100/50",onClick:()=>j(I?null:m.id),children:[e.jsxs("div",{className:"flex items-center space-x-3 overflow-hidden",children:[e.jsx("div",{className:`w-9 h-9 rounded-full flex-shrink-0 flex items-center justify-center font-bold text-sm ${H(((O=m.student)==null?void 0:O.name)||"?")}`,children:G(((Q=m.student)==null?void 0:Q.name)||"Unknown")}),e.jsxs("div",{className:"overflow-hidden",children:[e.jsxs("p",{className:"font-semibold text-text-primary truncate",children:[(Y=m.student)==null?void 0:Y.name," ",e.jsxs("span",{className:"font-normal text-xs text-text-secondary",children:["(",((Z=m.student)==null?void 0:Z.className)||"N/A",")"]})]}),e.jsx("p",{className:"text-xs text-text-secondary truncate",title:N,children:N})]})]}),e.jsxs("div",{className:"flex items-center space-x-2 flex-shrink-0",children:[C[m.type],e.jsx(ge,{className:`h-5 w-5 text-text-secondary transition-transform ${I?"rotate-180":""}`})]})]}),I&&e.jsxs("div",{className:"p-4 border-t border-border bg-white animate-fade-in-up",children:[m.type==="quest"?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("h5",{className:"font-semibold text-text-primary mb-1",children:"Quest Details"}),e.jsx("p",{className:"text-sm text-text-secondary",children:m.data.quest.description})]}),e.jsxs("div",{className:"p-3 bg-slate-100 rounded-lg border border-border",children:[e.jsx("h6",{className:"text-xs font-bold text-text-secondary uppercase mb-2",children:"Rewards for Completion"}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("span",{className:"font-bold text-lg text-secondary",children:["+",m.data.quest.points," Points"]}),m.data.quest.badgeTier&&e.jsxs("div",{className:"flex items-center gap-1.5 text-sm font-semibold bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full",children:[e.jsx(W,{badge:{tier:m.data.quest.badgeTier,icon:m.data.quest.badgeIcon},className:"h-4 w-4"}),e.jsxs("span",{children:["Badge: ",m.data.quest.badgeTier]})]})]})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("h5",{className:"font-semibold text-text-primary text-sm mb-2",children:"Student's Reason:"}),e.jsxs("p",{className:"text-text-primary my-2 p-3 bg-slate-50 border-l-4 border-slate-300 rounded text-sm",children:['"',m.data.reason,'"']}),m.data.originalLog&&e.jsxs(e.Fragment,{children:[e.jsx("h5",{className:"font-semibold text-text-primary text-sm mt-4 mb-2",children:"Original Log Details:"}),e.jsxs("div",{className:"p-3 bg-slate-50 border rounded-md text-sm space-y-1",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Description:"})," ",m.data.originalLog.description]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Points:"})," ",e.jsx("span",{className:"font-bold text-danger",children:m.data.originalLog.points})]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Awarded By:"})," ",((K=s.find(oe=>{var J;return oe.id===((J=m.data.originalLog)==null?void 0:J.addedBy)}))==null?void 0:K.name)||"N/A"]})]})]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-end gap-2 mt-4",children:[e.jsx(D,{size:"sm",variant:"danger",onClick:()=>w(m),children:"Reject"}),e.jsx(D,{size:"sm",variant:"secondary",onClick:()=>L(m),children:"Approve"})]})]})]},m.id)};return e.jsxs(e.Fragment,{children:[e.jsxs(q,{title:"Action Center",icon:e.jsx(X,{className:"h-5 w-5"}),children:[e.jsxs("div",{className:"flex flex-wrap gap-2 mb-4",children:[e.jsxs(D,{onClick:()=>g("all"),variant:o==="all"?"primary":"neutral",size:"sm",children:["All (",b.length,")"]}),e.jsxs(D,{onClick:()=>g("quest"),variant:o==="quest"?"primary":"neutral",size:"sm",children:["Quest Reviews (",b.filter(m=>m.type==="quest").length,")"]}),(r==null?void 0:r.role)==="head_of_class"&&e.jsxs(D,{onClick:()=>g("appeal"),variant:o==="appeal"?"primary":"neutral",size:"sm",children:["Appeals (",b.filter(m=>m.type==="appeal").length,")"]})]}),e.jsx("div",{className:"max-h-[40rem] overflow-y-auto pr-2 space-y-3",children:S.length===0?e.jsx("p",{className:"text-center text-text-secondary py-12",children:"Inbox is empty. All caught up!"}):S.map($)})]}),e.jsx(Ce,{isOpen:!!a,onClose:()=>i(null),onConfirm:v,title:"Confirm Approval",message:(a==null?void 0:a.type)==="quest"?`Are you sure you want to approve this submission for ${(A=a==null?void 0:a.student)==null?void 0:A.name}? This will grant them the associated points and/or badge.`:`Are you sure you want to approve this appeal for ${(E=a==null?void 0:a.student)==null?void 0:E.name}? This will reverse the original point deduction.`,confirmText:"Confirm Approval",confirmVariant:"secondary"}),e.jsx(Oe,{item:x,onClose:()=>w(null),onConfirm:R})]})},He=()=>{const{user:t}=_(),{selectedYear:p}=V(),[s,u]=n.useState(null),[f,h]=n.useState(!0),[r,c]=n.useState(null),l=Ie(t,B.HEAD_OF_CLASS),[o,g]=n.useState(T.REWARD),[d,j]=n.useState(null),[a,i]=n.useState(l?"myClass":"allStudents"),x=n.useCallback(async()=>{console.log("TeacherDashboard - fetchTeacherData called"),console.log("Current user:",t),console.log("User roles:",t==null?void 0:t.roles),h(!0),c(null);try{console.log("Making API call to getTeacherDashboardData...");const v=await ye({year:p});console.log("API response received:",v),u(v),d&&!v.students.find(R=>R.id===d)&&j(null)}catch(v){console.error("API call failed:",v),c("Failed to load dashboard data. Please try again later.")}finally{h(!1)}},[p,d,t]);n.useEffect(()=>{t&&x()},[t,x]);const w=n.useMemo(()=>!s||!(t!=null&&t.classId)?[]:s.students.filter(v=>v.classId===t.classId),[s,t]),b=n.useMemo(()=>{var E,m;if(!s)return console.log("TeacherDashboard - No data available"),[];const v=s.users||s.students;if(console.log("TeacherDashboard - Raw data structure:",{hasData:!!s,hasUsers:!!s.users,hasStudents:!!s.students,usersLength:((E=s.users)==null?void 0:E.length)||0,studentsLength:((m=s.students)==null?void 0:m.length)||0,allUsersLength:(v==null?void 0:v.length)||0,sampleUser:(v==null?void 0:v[0])||"No users"}),!v||v.length===0)return console.log("TeacherDashboard - No users found in data"),[];const R=v.filter(I=>{let C=!1;return Array.isArray(I.roles)&&(C=I.roles.some(N=>typeof N=="string"?N==="student":typeof N=="object"&&N.name?N.name==="student":!1)),console.log(`User ${I.firstName} ${I.lastName}:`,{roles:I.roles,hasStudentRole:C}),C});console.log("TeacherDashboard - Students filtered:",R.length);const A=[...R.map(I=>({...I,name:`${I.firstName||""} ${I.lastName||""}`.trim()||I.email||"Unknown User"}))].slice().sort((I,C)=>{const N=I.firstName||"",y=C.firstName||"";return N.localeCompare(y)});return console.log("TeacherDashboard - Final allStudents:",A.length,A),console.log("TeacherDashboard - Sample transformed student:",A[0]),A},[s]),S=n.useMemo(()=>s!=null&&s.users?s.users.map(v=>({...v,name:v.name||`${v.firstName||""} ${v.lastName||""}`.trim()||"Unknown User"})):b,[s==null?void 0:s.users,b]),L=n.useMemo(()=>b.find(v=>v.id===d)||null,[b,d]);return f?e.jsx(be,{}):r||!s?e.jsx("div",{className:"text-center text-danger p-8",children:r||"Could not load data."}):t?e.jsxs("div",{className:"space-y-8",children:[e.jsxs("h1",{className:"text-3xl font-bold text-text-primary",children:["Welcome back, ",t.name,"!"]}),l&&e.jsx("div",{className:"border-b border-border",children:e.jsxs("nav",{className:"-mb-px flex space-x-6","aria-label":"Tabs",children:[e.jsx("button",{type:"button",onClick:()=>i("myClass"),className:`whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm ${a==="myClass"?"border-primary text-primary":"border-transparent text-text-secondary hover:text-text-primary hover:border-gray-300"}`,children:"My Class"}),e.jsx("button",{type:"button",onClick:()=>i("allStudents"),className:`whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm ${a==="allStudents"?"border-primary text-primary":"border-transparent text-text-secondary hover:text-text-primary hover:border-gray-300"}`,children:"All Students"}),e.jsx("button",{type:"button",onClick:()=>i("profile"),className:`whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm ${a==="profile"?"border-primary text-primary":"border-transparent text-text-secondary hover:text-text-primary hover:border-gray-300"}`,children:"My Profile"})]})}),a==="myClass"&&l&&e.jsxs("div",{className:"space-y-6 animate-fade-in-up",children:[e.jsx(q,{icon:e.jsx(ae,{className:"h-6 w-6 text-primary"}),title:`My Class Roster (${t.className})`,children:e.jsx(Me,{students:w,points:s.points,onUpdate:x})}),e.jsx(Ae,{classStudents:w,classPoints:s.points}),e.jsx(se,{quests:s.quests,questParticipants:s.questParticipants,users:s.students,appeals:s.appeals,points:s.points,onUpdate:x})]}),a==="allStudents"&&e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8 animate-fade-in-up",children:[e.jsx("div",{className:"lg:col-span-1 space-y-6",children:e.jsxs(q,{icon:e.jsx(Ne,{className:"h-5 w-5"}),title:"Log Points & Medals",children:[e.jsxs("div",{className:"flex space-x-1 rounded-lg bg-slate-100 p-1 mb-4",children:[e.jsx(D,{type:"button",size:"md",className:"w-full",onClick:()=>g(T.REWARD),variant:o===T.REWARD?"primary":"neutral",children:"Reward"}),e.jsx(D,{type:"button",size:"md",className:"w-full",onClick:()=>g(T.VIOLATION),variant:o===T.VIOLATION?"primary":"neutral",children:"Violation"})]}),e.jsx(Le,{students:S,logType:o,onStudentSelect:j,onUpdate:x}),L&&e.jsx(ke,{student:L,points:s.points})]})}),e.jsx("div",{className:"lg:col-span-2 space-y-6",children:e.jsx(De,{students:b,onAward:x})})]}),a==="profile"&&l&&e.jsx("div",{className:"animate-fade-in-up",children:e.jsx(q,{icon:e.jsx(ve,{className:"h-5 w-5"}),title:"Edit My Profile",children:e.jsx(Te,{})})}),!l&&e.jsx(se,{quests:s.quests,questParticipants:s.questParticipants,users:s.students,appeals:s.appeals,points:s.points,onUpdate:x})]}):null};export{He as default};
