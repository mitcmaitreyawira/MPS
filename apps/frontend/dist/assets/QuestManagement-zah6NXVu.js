import{r as n,b as E,j as e,c as P,B as A,Z as F,$ as L,a0 as U,t as k,q as Q,a1 as $,a as z,I as v}from"./index-JBX9P6Qg.js";import{T as Z}from"./Table-DlSKKgO4.js";import{M as H}from"./Modal-NYefmAjZ.js";import{S as D}from"./Select-BM0zQtf0.js";import{S as J}from"./SearchableSingleUserSelector-DWlEu3dp.js";import{B as V}from"./BadgeIconRenderer-BjlOxHvs.js";import{C as _}from"./ConfirmationModal-CPL5EhPs.js";import"./helpers-snl2sRJ-.js";import"./useDebounce-CwzWEB2R.js";class y{constructor(){this.metrics=[],this.maxMetrics=100}static getInstance(){return y.instance||(y.instance=new y),y.instance}addMetric(l){this.metrics.push(l),this.metrics.length>this.maxMetrics&&this.metrics.shift()}getMetrics(){return[...this.metrics]}getAverageRenderTime(l){const o=this.metrics.filter(c=>c.componentName===l);return o.length===0?0:o.reduce((c,x)=>c+x.renderTime,0)/o.length}getSlowestComponents(l=5){return[...new Set(this.metrics.map(c=>c.componentName))].map(c=>({name:c,avgTime:this.getAverageRenderTime(c)})).sort((c,x)=>x.avgTime-c.avgTime).slice(0,l)}clear(){this.metrics=[]}}function G(s,l=!1){const o=n.useRef(0),d=y.getInstance(),c=n.useCallback(()=>{l&&(o.current=performance.now())},[l]),x=n.useCallback(()=>{if(l&&o.current>0){const f=performance.now()-o.current;d.addMetric({componentName:s,renderTime:f,timestamp:Date.now()}),o.current=0}},[l,s,d]);return c(),n.useEffect(()=>{x()}),{markRenderStart:c,markRenderEnd:x,getMetrics:()=>d.getMetrics(),getAverageRenderTime:()=>d.getAverageRenderTime(s),getSlowestComponents:()=>d.getSlowestComponents()}}const B=n.memo(({quest:s,users:l,onDone:o})=>{const{createQuest:d,updateQuest:c}=E(),[x,f]=n.useState(!!(s!=null&&s.badgeTier)),[N,b]=n.useState(!1),[h,u]=n.useState(null),[w,C]=n.useState(!1),[I,S]=n.useState(""),r=a=>a?new Date(a).toISOString().split("T")[0]:"",[t,j]=n.useState({title:(s==null?void 0:s.title)||"",description:(s==null?void 0:s.description)||"",points:(s==null?void 0:s.points)||25,isActive:(s==null?void 0:s.isActive)??!0,supervisorId:(s==null?void 0:s.supervisorId)||"",requiredPoints:(s==null?void 0:s.requiredPoints)||50,badgeTier:(s==null?void 0:s.badgeTier)||k.BRONZE,badgeReason:(s==null?void 0:s.badgeReason)||"",badgeIcon:(s==null?void 0:s.badgeIcon)||"",slotsAvailable:(s==null?void 0:s.slotsAvailable)||"",expiresAt:r(s==null?void 0:s.expiresAt)}),i=n.useMemo(()=>l.filter(a=>Array.isArray(a.roles)?a.roles.some(g=>g==="teacher"||g==="head_teacher"||g==="head_of_class")&&!a.isArchived:a.role?(a.role===Q.TEACHER||a.role===Q.HEAD_OF_CLASS)&&!a.isArchived:!1),[l]),m=n.useCallback(a=>{const{name:p,value:g,type:R}=a.target;j(R==="checkbox"?M=>({...M,[p]:a.target.checked}):M=>({...M,[p]:R==="number"&&g?Number(g):g}))},[]),T=async a=>{if(a.preventDefault(),u(null),!t.supervisorId){u("Please select a supervising teacher.");return}b(!0);const p={title:t.title,description:t.description,points:t.points,isActive:t.isActive,supervisorId:t.supervisorId,requiredPoints:t.requiredPoints,slotsAvailable:t.slotsAvailable?Number(t.slotsAvailable):void 0,expiresAt:t.expiresAt?new Date(t.expiresAt):void 0};if(x){if(!t.badgeReason){u("Please provide a reason/title for the badge."),b(!1);return}p.badgeTier=t.badgeTier,p.badgeReason=t.badgeReason,p.badgeIcon=t.badgeIcon||void 0}try{s?(await c(s.id,p),S("Quest updated successfully.")):(await d(p),S("Quest created successfully.")),C(!0)}catch(g){u(g.message)}finally{b(!1)}},O=$.map(a=>({name:a.charAt(0).toUpperCase()+a.slice(1).replace(/([A-Z])/g," $1"),value:a}));return w?e.jsxs("div",{className:"text-center p-4",children:[e.jsx(z,{className:"mx-auto h-12 w-12 text-secondary"}),e.jsx("h3",{className:"mt-2 text-lg font-medium text-text-primary",children:"Success!"}),e.jsx("p",{className:"mt-2 text-sm text-text-secondary",children:I}),e.jsx(A,{onClick:o,className:"mt-6",variant:"secondary",children:"Close"})]}):e.jsxs("form",{onSubmit:T,className:"space-y-4",children:[e.jsx(v,{name:"title",value:t.title,onChange:m,placeholder:"Quest Title",required:!0}),e.jsx(v,{name:"description",value:t.description,onChange:m,placeholder:"Description",required:!0}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(v,{name:"points",type:"number",value:t.points,onChange:m,placeholder:"Points Reward",required:!0}),e.jsx(v,{name:"requiredPoints",type:"number",value:t.requiredPoints,onChange:m,placeholder:"Max. Points to Join",required:!0})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-text-secondary mb-1 block",children:"Slots Available (Optional)"}),e.jsx(v,{name:"slotsAvailable",type:"number",min:"1",value:t.slotsAvailable,onChange:m,placeholder:"e.g., 10"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-text-secondary mb-1 block",children:"Expires At (Optional)"}),e.jsx(v,{name:"expiresAt",type:"date",value:t.expiresAt,onChange:m})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-text-secondary mb-1",children:"Supervising Teacher"}),e.jsx(J,{users:i,selectedUserId:t.supervisorId,onSelectUser:a=>j(p=>({...p,supervisorId:a})),placeholder:"Search and select a teacher...",required:!0})]}),e.jsxs("div",{className:"space-y-3 rounded-lg border border-border p-4",children:[e.jsxs("label",{className:"flex items-center space-x-3 cursor-pointer text-text-secondary",children:[e.jsx("input",{type:"checkbox",checked:x,onChange:a=>f(a.target.checked),className:"h-4 w-4 rounded border-slate-300 text-primary focus:ring-primary"}),e.jsx("span",{children:"Award a Badge on Completion"})]}),x&&e.jsxs("div",{className:"space-y-4 pt-3 border-t border-border animate-fade-in-up",children:[e.jsx(v,{name:"badgeReason",value:t.badgeReason,onChange:m,placeholder:"Badge Title (e.g., 'Science Fair Champion')",required:!0}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(D,{name:"badgeTier",value:t.badgeTier,onChange:m,children:Object.values(k).map(a=>e.jsx("option",{value:a,className:"capitalize",children:a},a))}),e.jsxs(D,{name:"badgeIcon",value:t.badgeIcon||"",onChange:m,children:[e.jsx("option",{value:"",children:"Default Icon"}),O.map(a=>e.jsx("option",{value:a.value,children:a.name},a.value))]})]})]})]}),e.jsxs("label",{className:"flex items-center space-x-3 cursor-pointer text-text-secondary",children:[e.jsx("input",{type:"checkbox",name:"isActive",checked:t.isActive,onChange:m,className:"h-4 w-4 rounded border-slate-300 text-primary focus:ring-primary"}),e.jsx("span",{children:"Is Active"})]}),h&&e.jsx("p",{className:"text-sm text-danger",children:h}),e.jsx(A,{type:"submit",className:"w-full !mt-6",disabled:N,children:N?s?"Updating...":"Creating...":s?"Update Quest":"Create Quest"})]})}),K=n.memo(({quests:s,questParticipants:l,users:o,onUpdate:d})=>{const{deleteQuest:c}=E();G("QuestManagement");const[x,f]=n.useState(!1),[N,b]=n.useState(void 0),[h,u]=n.useState(null),w=n.useMemo(()=>{if(!s||!l)return[];const r=new Map,t=new Map,j=new Map;return o.forEach(i=>{j.set(i.id,i.name)}),l.forEach(i=>{r.has(i.questId)||(r.set(i.questId,[]),t.set(i.questId,0)),r.get(i.questId).push(i),i.status==="completed"&&t.set(i.questId,(t.get(i.questId)||0)+1)}),s.map(i=>{const m=r.get(i.id)||[],T=i.slotsAvailable?i.slotsAvailable-m.length:1/0;return{...i,participants:m.length,completions:t.get(i.id)||0,supervisorName:j.get(i.supervisorId)||"N/A",slotsLeft:T}})},[s,l,o]),C=r=>{b(r),f(!0)},I=()=>{b(void 0),f(!1),d()},S=n.useCallback(async()=>{h&&(await c(h.id),d(),u(null))},[h,c,d]);return e.jsxs(e.Fragment,{children:[e.jsxs(P,{children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-xl font-semibold text-text-primary",children:"All Quests"}),e.jsxs(A,{onClick:()=>C(),children:[e.jsx(F,{className:"h-5 w-5 mr-2"}),"Add Quest"]})]}),e.jsx("div",{className:"max-h-[32rem] overflow-y-auto",children:e.jsx(Z,{headers:["Title","Rewards","Limits","Participation","Status","Actions"],children:w.map(r=>e.jsxs("tr",{children:[e.jsxs("td",{className:"px-6 py-3",children:[e.jsx("p",{className:"font-medium text-text-primary",children:r.title}),e.jsx("p",{className:"text-xs text-text-secondary truncate max-w-xs",children:r.description})]}),e.jsxs("td",{className:"px-6 py-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("span",{className:"font-bold text-secondary",children:[r.points," pts"]}),r.badgeTier&&e.jsx(V,{badge:{tier:r.badgeTier,icon:r.badgeIcon},className:"h-5 w-5"})]}),e.jsxs("p",{className:"text-xs text-text-secondary",children:["Max. ",r.requiredPoints," pts to join"]})]}),e.jsxs("td",{className:"px-6 py-3 text-xs text-text-secondary",children:[e.jsxs("p",{children:["Slots: ",isFinite(r.slotsLeft)?`${r.slotsLeft} left`:"Unlimited"]}),e.jsxs("p",{children:["Expires: ",r.expiresAt?new Date(r.expiresAt).toLocaleDateString():"Never"]})]}),e.jsxs("td",{className:"px-6 py-3",children:[e.jsxs("p",{className:"text-sm font-medium",children:[r.participants||0," Joined"]}),e.jsxs("p",{className:"text-xs text-text-secondary",children:[r.completions||0," Completed"]})]}),e.jsx("td",{className:"px-6 py-3",children:e.jsx("span",{className:`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${r.isActive?"bg-green-100 text-green-800":"bg-red-100 text-red-800"}`,children:r.isActive?"Active":"Inactive"})}),e.jsx("td",{className:"px-6 py-3",children:e.jsxs("div",{className:"flex space-x-2",children:[e.jsx(A,{size:"sm",variant:"secondary",onClick:()=>C(r),children:e.jsx(L,{className:"h-4 w-4"})}),e.jsx(A,{size:"sm",variant:"danger",onClick:()=>u(r),children:e.jsx(U,{className:"h-4 w-4"})})]})})]},r.id))})})]}),e.jsx(H,{isOpen:x,onClose:I,title:N?"Edit Quest":"Create New Quest",children:e.jsx(B,{quest:N,users:o,onDone:I})}),e.jsx(_,{isOpen:!!h,onClose:()=>u(null),onConfirm:S,title:"Confirm Deletion",message:e.jsxs("p",{className:"text-text-secondary mb-6",children:['Are you sure you want to delete the quest "',e.jsx("strong",{children:h==null?void 0:h.title}),'"? All participant progress for this quest will be lost. This action cannot be undone.']}),confirmText:"Confirm Delete",confirmVariant:"danger"})]})});B.displayName="QuestForm";K.displayName="QuestManagement";export{K as default};
