import{b as I,r as n,q as v,j as e,B as f,$ as E,a0 as U,Z as $,K as k,a as O,I as R}from"./index-JBX9P6Qg.js";import{A as _}from"./AdminDashboard-CCkNeIC3.js";import{T as H}from"./Table-DlSKKgO4.js";import{M as L}from"./Modal-NYefmAjZ.js";import{S as B}from"./SearchableSingleUserSelector-DWlEu3dp.js";import{C as q}from"./ConfirmationModal-CPL5EhPs.js";import{h as z}from"./roleUtils-D7XDrfnq.js";import"./Select-BM0zQtf0.js";import"./helpers-snl2sRJ-.js";import"./useDebounce-CwzWEB2R.js";const P=({classData:a,users:r,classes:t,onDone:A})=>{const{createClass:T,updateClass:p}=I(),[h,y]=n.useState((a==null?void 0:a.name)||""),[i,C]=n.useState((a==null?void 0:a.headTeacherId)||""),[m,g]=n.useState(!1),[x,j]=n.useState(null),[l,N]=n.useState(!1),[c,b]=n.useState(""),w=n.useMemo(()=>{if(console.log("ClassForm: Computing availableTeachers, users:",(r==null?void 0:r.length)||0,"classes:",(t==null?void 0:t.length)||0),!Array.isArray(t)||!Array.isArray(r))return console.log("ClassForm: Invalid data - classes or users not arrays"),[];const d=new Set(t.filter(s=>s.id!==(a==null?void 0:a.id)&&s.headTeacherId).map(s=>s.headTeacherId));console.log("ClassForm: Teachers assigned to other classes:",Array.from(d));const o=r.filter(s=>{if(console.log(`ClassForm: Checking user ${s.firstName} ${s.lastName}:`,{roles:s.roles,role:s.role,isArchived:s.isArchived,assignedToOther:d.has(s.id)}),Array.isArray(s.roles)&&s.roles.length>0){const u=s.roles.some(S=>S==="teacher"||S==="head_teacher"||S==="head_of_class")&&!s.isArchived&&!d.has(s.id);return console.log(`ClassForm: User ${s.firstName} available (roles check):`,u),u}if(s.role){const u=(s.role===v.TEACHER||s.role===v.HEAD_OF_CLASS)&&!s.isArchived&&!d.has(s.id);return console.log(`ClassForm: User ${s.firstName} available (role check):`,u),u}return console.log(`ClassForm: User ${s.firstName} has no valid role`),!1});return console.log("ClassForm: Available teachers found:",o.length,o.map(s=>`${s.firstName} ${s.lastName}`)),o},[r,t,a]),F=async d=>{d.preventDefault(),g(!0),j(null);try{const o={name:h,headTeacherId:i||void 0};if(console.log("ClassForm: Submitting class data:",o),a)console.log("ClassForm: Updating existing class:",a.id),await p(a.id,o),b("Class updated successfully.");else{console.log("ClassForm: Creating new class");const s=await T(o);console.log("ClassForm: Class created successfully:",s),b("Class created successfully.")}N(!0)}catch(o){console.error("ClassForm: Error during submission:",o),j(o.message),g(!1)}};return l?e.jsxs("div",{className:"text-center p-4",children:[e.jsx(O,{className:"mx-auto h-12 w-12 text-secondary"}),e.jsx("h3",{className:"mt-2 text-lg font-medium text-text-primary",children:"Success!"}),e.jsx("p",{className:"mt-2 text-sm text-text-secondary",children:c}),e.jsx(f,{onClick:A,className:"mt-6",variant:"secondary",children:"Close"})]}):e.jsxs("form",{onSubmit:F,className:"space-y-4",children:[e.jsx(R,{name:"name",value:h,onChange:d=>y(d.target.value),placeholder:"Class Name (e.g., Grade 10 - Section C)",required:!0}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-text-secondary mb-1",children:"Head Teacher (Optional)"}),e.jsx(B,{users:w,selectedUserId:i,onSelectUser:C,placeholder:"Search for an available teacher..."})]}),x&&e.jsx("p",{className:"text-sm text-danger",children:x}),e.jsx(f,{type:"submit",className:"w-full !mt-6",disabled:m,children:m?a?"Updating...":"Creating...":a?"Update Class":"Create Class"})]})},ee=({onUpdate:a})=>{const{classes:r,users:t,deleteClass:A}=I(),[T,p]=n.useState(!1),[h,y]=n.useState(void 0),[i,C]=n.useState(null),m=n.useMemo(()=>(console.log("ClassManagement: Computing class details, classes:",(r==null?void 0:r.length)||0,"classes"),Array.isArray(r)?r.map(l=>{var N;return{...l,headTeacherName:Array.isArray(t)&&((N=t.find(c=>c.id===l.headTeacherId&&c.roles&&(c.roles.includes("teacher")||c.roles.includes("head_of_class"))))==null?void 0:N.name)||"N/A",studentCount:Array.isArray(t)?t.filter(c=>c.classId===l.id&&z(c,v.STUDENT)).length:0}}):[]),[r,t]),g=l=>{y(l),p(!0)},x=()=>{console.log("ClassManagement: Closing modal and triggering data refresh"),y(void 0),p(!1),a()},j=async()=>{i&&(await A(i.id),a(),C(null))};return e.jsxs(e.Fragment,{children:[e.jsx(_,{title:"Class Management",description:`Manage classes and assign head teachers. Total: ${m.length} ${m.length===1?"class":"classes"}`,icon:e.jsx(k,{className:"h-6 w-6"}),actions:e.jsxs(f,{onClick:()=>g(),children:[e.jsx($,{className:"h-5 w-5 mr-2"}),"Add Class"]}),children:e.jsx("div",{className:"max-h-[32rem] overflow-y-auto",children:e.jsx(H,{headers:["Class Name","Head Teacher","Student Count","Actions"],children:m.map(l=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-6 py-3 font-medium text-text-primary",children:l.name}),e.jsx("td",{className:"px-6 py-3",children:l.headTeacherName}),e.jsx("td",{className:"px-6 py-3",children:l.studentCount}),e.jsx("td",{className:"px-6 py-3",children:e.jsxs("div",{className:"flex space-x-2",children:[e.jsx(f,{size:"sm",variant:"secondary",onClick:()=>g(l),children:e.jsx(E,{className:"h-4 w-4"})}),e.jsx(f,{size:"sm",variant:"danger",onClick:()=>C(l),children:e.jsx(U,{className:"h-4 w-4"})})]})})]},l.id))})})}),e.jsx(L,{isOpen:T,onClose:x,title:h?"Edit Class":"Create New Class",children:e.jsx(P,{classData:h,users:t,classes:r,onDone:x})}),e.jsx(q,{isOpen:!!i,onClose:()=>C(null),onConfirm:j,title:"Confirm Deletion",message:e.jsxs("p",{children:['Are you sure you want to delete the class "',e.jsx("strong",{children:i==null?void 0:i.name}),'"? This will unassign all students and the head teacher. This action cannot be undone.']}),confirmText:"Confirm Delete",confirmVariant:"danger"})]})};export{ee as ClassManagement};
